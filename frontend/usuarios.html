<!-- usuarios.html -->

<!-- usuarios.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MIDIs de Usuarios üéµ</title>
  <link rel="icon" href="favicon.ico"/>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <header>
    <h1>Generador de Melod√≠as</h1>
    <nav class="navbar">
      <div class="nav-center">
        <a href="index.html">Generador</a>
        <a href="usuarios.html" class="active">MIDIs de otros usuarios</a>
      </div>
      <div class="profile-menu">
        <img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png"
             alt="Perfil" class="profile-icon"/>
        <div class="dropdown-content">
          <a href="login.html">Iniciar sesi√≥n</a>
          <a href="register.html">Registrarse</a>
          <a href="mis_melodias.html">Mis melod√≠as</a>
          <a href="#" id="logout">Cerrar sesi√≥n</a>
        </div>
      </div>
    </nav>
  </header>

  <div class="container">
    <h2>MIDIs de Otros Usuarios üéß</h2>

    <div id="midiSection" style="display: none;">
      <p>Descarga melod√≠as compartidas por la comunidad:</p>
      <div id="midiList" class="midi-grid"></div>

      <div id="uploadSection">
        <h3>üì§ Sube tu propia melod√≠a</h3>
        <label for="scaleNote">Nota:</label>
        <input list="noteList" id="scaleNote" placeholder="Ej.: C"/>
        <datalist id="noteList">
          <option value="C">
          <option value="C#">
          <option value="D">
          <option value="D#">
          <option value="E">
          <option value="F">
          <option value="F#">
          <option value="G">
          <option value="G#">
          <option value="A">
          <option value="A#">
          <option value="B">
        </datalist>

        <label for="scaleMode">Modo:</label>
        <select id="scaleMode">
          <option value="MAJOR">Major</option>
          <option value="MINOR">Minor</option>
        </select>

        <input type="file" id="midiUpload" accept=".mid"/>
        <button id="uploadBtn">Subir MIDI</button>
        <p id="uploadError"
           style="color: var(--error); display:none; margin-top:8px;">
          ‚ùå Rellena Nota, Modo y selecciona un archivo .mid
        </p>
      </div>
    </div>

    <p id="loginWarning"
       style="text-align:center; margin-top:40px;">
      üîí Debes iniciar sesi√≥n para acceder a las melod√≠as de la comunidad.
    </p>
  </div>

  <footer>
    <p>üéº Generador de Melod√≠as ‚Äì Desarrollado por Asier Iturriotz ¬© 2025</p>
  </footer>

  <script>
    // ---- Men√∫ perfil --------------------
    const profileMenu = document.querySelector(".profile-menu");
    const dropdown    = document.querySelector(".dropdown-content");
    let hideTimeout;
    profileMenu.addEventListener("mouseenter", () => {
      clearTimeout(hideTimeout);
      dropdown.classList.add("show-dropdown");
    });
    profileMenu.addEventListener("mouseleave", () => {
      hideTimeout = setTimeout(() => {
        dropdown.classList.remove("show-dropdown");
      }, 1000);
    });
    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("token");
      alert("üëã Has cerrado sesi√≥n");
      window.location.href = "login.html";
    });

    // ---- Token & usuario ----------------
    function obtenerUsuarioDesdeToken() {
      const token = localStorage.getItem("token");
      if (!token) return null;
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.sub || null;
      } catch {
        return null;
      }
    }
    const username = obtenerUsuarioDesdeToken();
    if (username) {
      document.getElementById("midiSection").style.display  = "block";
      document.getElementById("loginWarning").style.display = "none";
      cargarMelodias();
    }

    // ---- Carga comunidad -----------------
    async function cargarMelodias() {
      try {
        const res      = await fetch("http://127.0.0.1:8000/melodias");
        const melodias = await res.json();
        const midiList = document.getElementById("midiList");
        midiList.innerHTML = "";

        // ordenar por timestamp (parte despu√©s de "_") para que los m√°s nuevos queden al final
        melodias.sort((a, b) => {
          const tA = Number( a.split("_")[1]?.replace(".mid","") || 0 );
          const tB = Number( b.split("_")[1]?.replace(".mid","") || 0 );
          return tA - tB;
        });

        melodias.forEach((nombre, idx) => {
          // extraer escala limpia:
          let clean = nombre.replace('.mid','');
          let escala;
          if (clean.includes('_')) {
            escala = clean.split('_')[0];            // ej. "CMAJOR"
          } else if (clean.includes(' - ')) {
            escala = clean.split(' - ')[1];           // ej. "AMINOR"
          } else {
            escala = clean;
          }

          const card = document.createElement("div");
          card.className = "midi-card";
          card.innerHTML = `
            <h4>MIDI ${idx+1} - ${escala}</h4>
            <a href="http://127.0.0.1:8000/melodias/${encodeURIComponent(nombre)}" download>
              ‚¨á Descargar
            </a>
            <div id="valoracion-${nombre}" class="valoracion-block">
              Cargando valoraci√≥n...
            </div>
          `;
          midiList.appendChild(card);
          actualizarValoracion(nombre);
        });
      } catch(err) {
        console.error("Error cargando comunidad:", err);
      }
    }

    // ---- Valoraciones -------------------
    async function actualizarValoracion(midiName) {
      try {
        const resp = await fetch(
          `http://127.0.0.1:8000/valoraciones/${encodeURIComponent(midiName)}`
        );
        const data = await resp.json();
        const cont = document.getElementById(`valoracion-${midiName}`);
        let html   = `<div style="margin-top:18px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.15);">`;

        if (data.valoracion_media !== null) {
          const stars = Math.round(data.valoracion_media);
          html += `<div style="color:gold;font-size:18px;margin-bottom:6px;">
                     ‚≠ê ${'‚òÖ'.repeat(stars)}${'‚òÜ'.repeat(5-stars)} (${data.cantidad_votos} votos)
                   </div>`;
        } else {
          html += `<div style="color:gray;font-size:15px;margin-bottom:6px;">
                     Sin valoraciones a√∫n. ¬°S√© el primero en valorar!
                   </div>`;
        }

        html += `<div style="margin-top:8px;font-size:22px;">`;
        [1,2,3,4,5].forEach(p => {
          html += `<span style="cursor:pointer;color:white;"
                        onclick="valorar('${midiName}',${p})">‚òÖ</span>`;
        });
        html += `</div></div>`;

        cont.innerHTML = html;
      } catch(e) {
        console.error("Error valoraci√≥n:", e);
      }
    }

    async function valorar(midiName, puntuacion) {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Debes iniciar sesi√≥n para valorar.");
        return;
      }
      try {
        const resp = await fetch("http://127.0.0.1:8000/valorar", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ midi_name: midiName, puntuacion })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.detail);
        alert(`‚úÖ Valoraste "${midiName}" con ${puntuacion} estrellas`);
        actualizarValoracion(midiName);
      } catch(err) {
        alert("‚ùå Error al valorar: " + err.message);
      }
    }

    // ---- Subida de MIDI -----------------
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const note   = document.getElementById("scaleNote").value.trim().toUpperCase();
      const mode   = document.getElementById("scaleMode").value.toUpperCase();
      const fileIn = document.getElementById("midiUpload");
      const errP   = document.getElementById("uploadError");
      const token  = localStorage.getItem("token");

      if (!note || !mode || !fileIn.files.length) {
        errP.style.display = "block";
        return;
      }
      errP.style.display = "none";

      // renombrar con escala y timestamp
      const rawFile   = fileIn.files[0];
      const timestamp = Date.now();
      const newName   = `${note}${mode}_${timestamp}.mid`;

      const formData = new FormData();
      formData.append("file", rawFile, newName);

      try {
        const res = await fetch("http://127.0.0.1:8000/melodias/upload", {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}` },
          body: formData
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "upload failed");
        }
        alert("‚úÖ Melod√≠a subida correctamente.");
        fileIn.value = "";
        cargarMelodias();
      } catch(e) {
        console.error(e);
        alert("‚ùå Error al subir la melod√≠a: " + e.message);
      }
    });
  </script>
</body>
</html>
